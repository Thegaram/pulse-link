<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Pulse Link - Synchronized metronome for musicians via P2P WebRTC">
  <title>Pulse Link</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="shell">
    <main class="app">
    <header class="tabs" role="tablist" aria-label="Mode">
      <button id="hostTabBtn" class="tab active" role="tab" aria-selected="true">Host</button>
      <button id="joinTabBtn" class="tab" role="tab" aria-selected="false">Join</button>
    </header>

    <section id="hostView" class="view">
      <div id="hostShare" class="room-share" title="Copy code and show QR">
        <button id="regenRoomBtn" class="qr-icon-btn qr-icon-left" aria-label="Reset room and generate new code">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M17.7 6.3A8 8 0 1 0 20 12h-2a6 6 0 1 1-1.76-4.24L13 11h8V3l-3.3 3.3z"></path>
          </svg>
        </button>
        <button id="openQrBtn" class="qr-icon-btn" aria-label="Show room QR code">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <rect x="3" y="3" width="6" height="6"></rect>
            <rect x="15" y="3" width="6" height="6"></rect>
            <rect x="3" y="15" width="6" height="6"></rect>
            <rect x="16" y="16" width="2" height="2"></rect>
            <rect x="19" y="16" width="2" height="2"></rect>
            <rect x="16" y="19" width="2" height="2"></rect>
            <rect x="11" y="11" width="2" height="2"></rect>
            <rect x="13" y="13" width="2" height="2"></rect>
          </svg>
        </button>
        <div id="hostRoomCode" class="room-code">------</div>
      </div>

      <div class="stage">
        <div id="hostBeat" class="beat"></div>
      </div>

      <div class="host-bpm-value" id="hostBpmValue">120</div>

      <div class="control-row">
        <button id="bpmDownBtn" class="btn btn-soft btn-big" aria-label="Decrease BPM">-</button>
        <button id="bpmUpBtn" class="btn btn-soft btn-big" aria-label="Increase BPM">+</button>
        <button id="startBtn" class="btn btn-primary">Start</button>
        <button id="stopBtn" class="btn btn-danger">Stop</button>
      </div>

      <p id="hostStatus" class="status">Connected peers: 0</p>
    </section>

    <section id="joinView" class="view hidden">
      <div id="joinEntry" class="join-entry">
        <div id="joinCodeLine" class="code-line" aria-label="6-character room code" tabindex="0">
          <span id="joinCodeVisual" class="code-line-visual">_ _ _ _ _ _</span>
          <input
            id="joinCodeInput"
            class="code-line-input"
            type="text"
            inputmode="text"
            maxlength="6"
            autocomplete="one-time-code"
            aria-label="Room code"
          >
        </div>
        <p id="joinStatus" class="status">Enter a room code to join.</p>
      </div>

      <div id="joinLive" class="join-live hidden">
        <div class="stage">
          <div id="joinBeat" class="beat"></div>
        </div>
        <div class="join-bpm-block">
          <div id="joinBpmValue" class="join-bpm-value">120</div>
          <div class="join-bpm-label">BPM</div>
        </div>
        <p id="joinLiveStatus" class="status">Connected. Waiting for host to start.</p>
      </div>
    </section>
    </main>
    <div id="appVersion" class="app-version"></div>
  </div>

  <div id="qrModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="qrTitle">
    <div class="modal-card">
      <h2 id="qrTitle">Share Room</h2>
      <div id="qrcode"></div>
      <button id="closeQrBtn" class="btn btn-primary">Close</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { LeaderStateMachine } from './dist/state/leader-machine.js';
    import { PeerStateMachine } from './dist/state/peer-machine.js';
    import { generatePeerId } from './dist/types.js';
    import { ICE_CONFIG } from './config.js';

    const MIN_BPM = 40;
    const MAX_BPM = 240;
    const BPM_UPDATE_DEBOUNCE_MS = 100;
    const APP_VERSION = '5250df1-local';
    const HOST_ROOM_STORAGE_KEY = 'pulse_link_host_room_code';
    let leader = null;
    let peer = null;
    let currentRoomId = null;
    let currentBpm = 120;
    let activeTab = 'host';
    let joinBpmTimer = null;
    let hostStatusTimer = null;
    let hostStatusOverrideUntil = 0;
    let hostStatusOverrideText = '';
    let joinInProgress = false;

    const hostTabBtn = document.getElementById('hostTabBtn');
    const joinTabBtn = document.getElementById('joinTabBtn');
    const hostView = document.getElementById('hostView');
    const joinView = document.getElementById('joinView');

    const hostShare = document.getElementById('hostShare');
    const regenRoomBtn = document.getElementById('regenRoomBtn');
    const openQrBtn = document.getElementById('openQrBtn');
    const hostRoomCode = document.getElementById('hostRoomCode');
    const hostBeat = document.getElementById('hostBeat');
    const hostStatus = document.getElementById('hostStatus');
    const hostBpmValue = document.getElementById('hostBpmValue');

    const bpmDownBtn = document.getElementById('bpmDownBtn');
    const bpmUpBtn = document.getElementById('bpmUpBtn');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');

    const joinEntry = document.getElementById('joinEntry');
    const joinLive = document.getElementById('joinLive');
    const joinCodeLine = document.getElementById('joinCodeLine');
    const joinCodeVisual = document.getElementById('joinCodeVisual');
    const joinCodeInput = document.getElementById('joinCodeInput');
    const joinStatus = document.getElementById('joinStatus');
    const joinLiveStatus = document.getElementById('joinLiveStatus');
    const joinBeat = document.getElementById('joinBeat');
    const joinBpmValue = document.getElementById('joinBpmValue');

    const qrModal = document.getElementById('qrModal');
    const qrNode = document.getElementById('qrcode');
    const closeQrBtn = document.getElementById('closeQrBtn');
    const appVersion = document.getElementById('appVersion');
    let bpmHoldIntervalId = null;
    let bpmHoldStartTimeoutId = null;
    let suppressPointerClickUntil = 0;
    let bpmUpdateDebounceTimeoutId = null;

    function refreshHostStatus() {
      if (Date.now() < hostStatusOverrideUntil) {
        hostStatus.textContent = hostStatusOverrideText;
        return;
      }

      const peers = leader ? leader.getPeerCount() : 0;
      hostStatus.textContent = `Connected peers: ${peers}`;
    }

    function showHostTemporaryStatus(text, durationMs = 1200) {
      hostStatusOverrideText = text;
      hostStatusOverrideUntil = Date.now() + durationMs;
      refreshHostStatus();
    }

    function stopHostStatusTimer() {
      if (hostStatusTimer !== null) {
        clearInterval(hostStatusTimer);
        hostStatusTimer = null;
      }
    }

    function startHostStatusTimer() {
      stopHostStatusTimer();
      refreshHostStatus();
      hostStatusTimer = setInterval(() => {
        refreshHostStatus();
      }, 500);
    }

    function setJoinStatus(text) {
      joinStatus.textContent = text;
    }

    function setJoinLiveStatus(text) {
      joinLiveStatus.textContent = text;
    }

    function getJoinCode() {
      return joinCodeInput.value;
    }

    function setJoinCode(code) {
      const normalized = code.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 6);
      joinCodeInput.value = normalized;
      renderJoinCodeVisual();
    }

    function setJoinInputDisabled(disabled) {
      joinCodeInput.disabled = disabled;
      joinCodeLine.classList.toggle('disabled', disabled);
    }

    function renderJoinCodeVisual() {
      const chars = joinCodeInput.value.split('');
      const display = Array.from({ length: 6 }, (_, i) => chars[i] ?? '_').join(' ');
      joinCodeVisual.textContent = display;
    }

    function clampBpm(value) {
      return Math.max(MIN_BPM, Math.min(MAX_BPM, value));
    }

    function setHostRoomCode(code) {
      currentRoomId = code;
      hostRoomCode.textContent = code || '------';

      if (code) {
        localStorage.setItem(HOST_ROOM_STORAGE_KEY, code);
      } else {
        localStorage.removeItem(HOST_ROOM_STORAGE_KEY);
      }
    }

    function loadStoredHostRoomCode() {
      const stored = localStorage.getItem(HOST_ROOM_STORAGE_KEY);
      if (!stored) {
        return null;
      }

      const normalized = stored.toUpperCase().trim();
      if (!/^[A-Z0-9]{6}$/.test(normalized)) {
        localStorage.removeItem(HOST_ROOM_STORAGE_KEY);
        return null;
      }

      return normalized;
    }

    function roomUrl(roomId) {
      const base = `${window.location.origin}${window.location.pathname}`;
      return `${base}?room=${roomId}`;
    }

    function flashBeat(node, isDownbeat) {
      node.classList.remove('flash', 'downbeat');
      void node.offsetWidth;
      node.classList.add('flash');
      if (isDownbeat) {
        node.classList.add('downbeat');
      }
    }

    function updateHostControls() {
      const hasLeader = Boolean(leader);
      const state = leader?.getState();
      const activePlayback = state === 'L_RUNNING';

      bpmDownBtn.disabled = !hasLeader;
      bpmUpBtn.disabled = !hasLeader;
      startBtn.disabled = !hasLeader || activePlayback;
      stopBtn.disabled = !hasLeader || !activePlayback;
    }

    function applyHostBpm(value) {
      const parsed = Number.parseInt(String(value), 10);
      currentBpm = clampBpm(Number.isNaN(parsed) ? currentBpm : parsed);
      hostBpmValue.textContent = String(currentBpm);

      if (leader) {
        const state = leader.getState();
        const running = state === 'L_RUNNING';

        if (running) {
          if (bpmUpdateDebounceTimeoutId !== null) {
            clearTimeout(bpmUpdateDebounceTimeoutId);
          }
          bpmUpdateDebounceTimeoutId = window.setTimeout(() => {
            bpmUpdateDebounceTimeoutId = null;
            if (leader) {
              leader.setBPM(currentBpm);
            }
          }, BPM_UPDATE_DEBOUNCE_MS);
        } else {
          leader.setBPM(currentBpm);
        }
      }
    }

    function stopBpmHold() {
      if (bpmHoldStartTimeoutId !== null) {
        clearTimeout(bpmHoldStartTimeoutId);
        bpmHoldStartTimeoutId = null;
      }
      if (bpmHoldIntervalId !== null) {
        clearInterval(bpmHoldIntervalId);
        bpmHoldIntervalId = null;
      }
    }

    function applyBpmDelta(delta) {
      if (!leader) {
        return;
      }
      applyHostBpm(currentBpm + delta);
    }

    function attachBpmHold(button, delta) {
      button.addEventListener('pointerdown', (event) => {
        if (!leader || event.button !== 0) {
          return;
        }
        event.preventDefault();
        suppressPointerClickUntil = Date.now() + 300;
        applyBpmDelta(delta);

        stopBpmHold();
        bpmHoldStartTimeoutId = window.setTimeout(() => {
          bpmHoldIntervalId = window.setInterval(() => {
            applyBpmDelta(delta);
          }, 70);
        }, 300);
      });

      button.addEventListener('pointerup', stopBpmHold);
      button.addEventListener('pointerleave', stopBpmHold);
      button.addEventListener('pointercancel', stopBpmHold);

      // Keyboard activation still dispatches click with detail=0.
      button.addEventListener('click', (event) => {
        if (!leader) {
          return;
        }
        if (event.detail > 0 && Date.now() < suppressPointerClickUntil) {
          return;
        }
        applyBpmDelta(delta);
      });
    }

    function clearJoinTimer() {
      if (joinBpmTimer !== null) {
        clearInterval(joinBpmTimer);
        joinBpmTimer = null;
      }
    }

    function showJoinEntry() {
      joinEntry.classList.remove('hidden');
      joinLive.classList.add('hidden');
      clearJoinTimer();
      joinInProgress = false;
      setJoinInputDisabled(false);
      joinCodeInput.focus();
    }

    function showJoinLive() {
      joinEntry.classList.add('hidden');
      joinLive.classList.remove('hidden');
    }

    function activateTab(tab) {
      activeTab = tab;

      const isHost = tab === 'host';
      hostTabBtn.classList.toggle('active', isHost);
      hostTabBtn.setAttribute('aria-selected', String(isHost));
      joinTabBtn.classList.toggle('active', !isHost);
      joinTabBtn.setAttribute('aria-selected', String(!isHost));

      hostView.classList.toggle('hidden', !isHost);
      joinView.classList.toggle('hidden', isHost);
    }

    async function ensureHostRoom(forceNewCode = false) {
      if (leader) {
        updateHostControls();
        return;
      }

      leader = new LeaderStateMachine(generatePeerId());
      leader.getMetronome().onBeatScheduled((_, isDownbeat) => {
        flashBeat(hostBeat, isDownbeat);
      });

      const preferredRoomId = forceNewCode ? undefined : loadStoredHostRoomCode();
      const roomId = await leader.createRoom(currentBpm, ICE_CONFIG, preferredRoomId ?? undefined);
      setHostRoomCode(roomId);
      startHostStatusTimer();
      updateHostControls();
    }

    async function regenerateHostRoom() {
      if (activeTab !== 'host') {
        return;
      }

      if (leader) {
        await teardownHost();
      }

      // Reset BPM to default on full room reset.
      applyHostBpm(120);

      // Ensure new code instead of reusing localStorage value.
      await ensureHostRoom(true);
      showHostTemporaryStatus('New room code generated');
    }

    async function teardownHost() {
      if (!leader) {
        return;
      }

      if (bpmUpdateDebounceTimeoutId !== null) {
        clearTimeout(bpmUpdateDebounceTimeoutId);
        bpmUpdateDebounceTimeoutId = null;
      }

      leader.stopMetronome();
      await leader.closeRoom();
      leader = null;
      setHostRoomCode(null);
      stopHostStatusTimer();
      refreshHostStatus();
      updateHostControls();
    }

    async function teardownPeer() {
      if (!peer) {
        return;
      }

      await peer.leaveRoom();
      peer = null;
      clearJoinTimer();
      showJoinEntry();
      setJoinStatus('Enter a room code to join.');
    }

    async function switchToHost() {
      await teardownPeer();
      activateTab('host');
      await ensureHostRoom();
    }

    async function switchToJoin() {
      await teardownHost();
      activateTab('join');
      showJoinEntry();
    }

    async function joinRoom(roomId) {
      await teardownPeer();
      setJoinStatus('Joining room...');
      joinInProgress = true;
      setJoinInputDisabled(true);

      peer = new PeerStateMachine(generatePeerId());
      peer.getMetronome().onBeatScheduled((_, isDownbeat) => {
        flashBeat(joinBeat, isDownbeat);
      });

      peer.onStart(() => {
        showJoinLive();
        setJoinLiveStatus('Running.');

        joinBpmValue.textContent = String(peer.getMetronome().getBPM());
        clearJoinTimer();
        joinBpmTimer = setInterval(() => {
          if (peer) {
            joinBpmValue.textContent = String(peer.getMetronome().getBPM());
          }
        }, 300);
      });

      peer.onSyncStatus((status) => {
        showJoinLive();
        setJoinLiveStatus(status);
      });

      await peer.joinRoom(roomId, ICE_CONFIG);
      showJoinLive();
      setJoinLiveStatus('Connected. Waiting for host to start.');
      joinInProgress = false;
    }

    function maybeAutoJoin() {
      if (activeTab !== 'join' || joinInProgress || peer) {
        return;
      }

      const roomId = getJoinCode();
      if (roomId.length !== 6) {
        return;
      }

      joinRoom(roomId).catch((error) => {
        console.error(error);
        joinInProgress = false;
        setJoinInputDisabled(false);
        setJoinStatus('Join failed. Try another code.');
        showJoinEntry();
      });
    }

    async function copyCodeOnly() {
      if (!currentRoomId) {
        return;
      }

      try {
        await navigator.clipboard.writeText(currentRoomId);
        showHostTemporaryStatus('Code copied');
      } catch {}
    }

    function openQrModal() {
      if (!currentRoomId) {
        return;
      }

      qrNode.innerHTML = '';
      new QRCode(qrNode, {
        text: roomUrl(currentRoomId),
        width: 220,
        height: 220,
        colorDark: '#111111',
        colorLight: '#ffffff'
      });
      qrModal.classList.remove('hidden');
    }

    hostTabBtn.addEventListener('click', () => {
      if (activeTab !== 'host') {
        switchToHost().catch((error) => {
          console.error(error);
          stopHostStatusTimer();
          hostStatus.textContent = 'Connected peers: 0';
        });
      }
    });

    joinTabBtn.addEventListener('click', () => {
      if (activeTab !== 'join') {
        switchToJoin().catch((error) => {
          console.error(error);
          setJoinStatus('Failed to open join mode.');
        });
      }
    });

    hostShare.addEventListener('click', () => {
      copyCodeOnly().catch((error) => {
        console.error(error);
      });
    });

    openQrBtn.addEventListener('click', (event) => {
      event.stopPropagation();
      openQrModal();
    });

    regenRoomBtn.addEventListener('click', (event) => {
      event.stopPropagation();
      regenerateHostRoom().catch((error) => {
        console.error(error);
        hostStatus.textContent = 'Connected peers: 0';
      });
    });

    closeQrBtn.addEventListener('click', () => {
      qrModal.classList.add('hidden');
    });

    qrModal.addEventListener('click', (event) => {
      if (event.target === qrModal) {
        qrModal.classList.add('hidden');
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !qrModal.classList.contains('hidden')) {
        qrModal.classList.add('hidden');
      }
    });

    document.addEventListener('pointerup', stopBpmHold);

    attachBpmHold(bpmDownBtn, -1);
    attachBpmHold(bpmUpBtn, +1);

    startBtn.addEventListener('click', () => {
      if (!leader) {
        return;
      }

      if (bpmUpdateDebounceTimeoutId !== null) {
        clearTimeout(bpmUpdateDebounceTimeoutId);
        bpmUpdateDebounceTimeoutId = null;
        leader.setBPM(currentBpm);
      }

      leader.startMetronome();
      updateHostControls();
    });

    stopBtn.addEventListener('click', () => {
      if (!leader) {
        return;
      }

      leader.stopMetronome();
      updateHostControls();
    });

    joinCodeLine.addEventListener('click', () => {
      if (!joinCodeInput.disabled) {
        joinCodeInput.focus();
      }
    });

    joinCodeInput.addEventListener('input', () => {
      joinCodeInput.value = joinCodeInput.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 6);
      renderJoinCodeVisual();
      maybeAutoJoin();
    });

    joinCodeInput.addEventListener('paste', (event) => {
      event.preventDefault();
      const pasted = (event.clipboardData?.getData('text') ?? '').toUpperCase();
      setJoinCode(pasted);
      maybeAutoJoin();
    });

    applyHostBpm(currentBpm);
    appVersion.textContent = APP_VERSION;
    renderJoinCodeVisual();

    const sharedRoom = new URLSearchParams(window.location.search).get('room');
    if (sharedRoom && sharedRoom.trim().length === 6) {
      activateTab('join');
      setJoinCode(sharedRoom.trim().toUpperCase());
      showJoinEntry();
      setJoinStatus('Joining room...');
      maybeAutoJoin();
    } else {
      activateTab('host');
      ensureHostRoom().catch((error) => {
        console.error(error);
        hostStatus.textContent = 'Connected peers: 0';
      });
    }
  </script>
</body>
</html>
